<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-key="title">Bitcoin Mining Simulator</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1 data-key="title">Bitcoin Mining Simulator</h1>
      <nav>
        <button onclick="showTab('mining')" class="active" data-key="mining_tab">Mining</button>
        <button onclick="showTab('trading')" data-key="trading_tab">Trading</button>
        <button onclick="showTab('shop')" data-key="shop_tab">Shop</button>
        <button onclick="showTab('missions')" data-key="missions_tab">Missions</button>
        <select id="language" onchange="changeLanguage(this.value)">
          <option value="en">English</option>
          <option value="th">ไทย</option>
        </select>
      </nav>
    </header>

    <div id="mining" class="tab-content active">
      <div class="dashboard">
        <div class="stats-card">
          <h2 data-key="stats_title">Mining Status</h2>
          <p data-key="level">Level: <span id="level">1</span></p>
          <p data-key="exp">EXP: <span id="exp">0</span>/<span id="expNeeded">100</span></p>
          <p data-key="hash_rate">Hash Rate: <span id="hashRate">0</span> H/s</p>
          <p data-key="power_consumption">Power Consumption: <span id="powerConsumption">0</span> kW</p>
          <p data-key="total_power_used">Total Power Used: <span id="totalPowerUsed">0</span> kWh</p>
          <p data-key="bitcoin_mined">Bitcoin Mined: <span id="bitcoinMined">0</span> BTC</p>
          <p data-key="blocks_mined">Blocks Mined: <span id="blocksMined">0</span></p>
          <p data-key="block_reward">Block Reward: <span id="blockReward">0</span> BTC</p>
          <p data-key="wallet">Wallet: $<span id="wallet">0</span></p>
          <p data-key="btc_price">BTC Price: $<span id="btcPrice">0</span></p>
          <p data-key="difficulty">Difficulty: <span id="difficulty">0</span></p>
          <p data-key="energy_type">Energy Type: <span id="energyType">grid</span></p>
          <p data-key="solar_power">Solar Power: <span id="solarPower">0</span> kW</p>
          <p data-key="temp">Temperature: <span id="temp">20</span>°C</p>
          <p data-key="gpu_level">GPU Level: <span id="gpuLevel">1</span></p>
        </div>
        <div class="controls-card">
          <h2 data-key="controls_title">Controls</h2>
          <button class="start-btn" onclick="startMining()" data-key="start_mining">Start Mining</button>
          <button class="stop-btn" onclick="stopMining()" data-key="stop_mining">Stop Mining</button>
          <button class="save-btn" onclick="saveGame()" data-key="save_game">Save Game</button>
          <button class="load-btn" onclick="loadGame()" data-key="load_game">Load Game</button>
          <div id="miningLog" class="mining-log"></div>
        </div>
      </div>
      <div class="chart-card">
        <h2 data-key="chart_title">Data Graph</h2>
        <canvas id="miningChart" width="400" height="200"></canvas>
      </div>
    </div>

    <div id="trading" class="tab-content">
      <h2 data-key="trading_title">Trading</h2>
      <div class="trading-card">
        <p data-key="btc_price">Current BTC Price: $<span id="tradeBtcPrice">0</span></p>
        <p data-key="bitcoin_mined">Your BTC: <span id="tradeBitcoinMined">0</span> BTC</p>
        <p data-key="wallet">Your Wallet: $<span id="tradeWallet">0</span></p>
        <input type="number" id="tradeAmount" min="0" step="0.01" placeholder="Amount">
        <button onclick="tradeBTC('buy')" data-key="buy_btc">Buy BTC</button>
        <button onclick="tradeBTC('sell')" data-key="sell_btc">Sell BTC</button>
      </div>
    </div>

    <div id="shop" class="tab-content">
      <h2 data-key="shop_title">Shop</h2>
      <div class="shop-items">
        <div class="shop-item" id="basicRig">
          <p data-key="basic_rig_name">Basic Rig</p>
          <p>5000 H/s, +0.5 kW, $1000</p>
          <button onclick="upgradeRig(5000, 0.5, 1000, 'basicRig')" data-key="buy">Buy</button>
        </div>
        <div class="shop-item" id="advancedRig">
          <p data-key="advanced_rig_name">Advanced Rig</p>
          <p>20000 H/s, +2 kW, $5000</p>
          <button onclick="upgradeRig(20000, 2, 5000, 'advancedRig')" data-key="buy">Buy</button>
        </div>
        <div class="shop-item" id="proRig">
          <p data-key="pro_rig_name">Pro Rig</p>
          <p>100000 H/s, +10 kW, $25000</p>
          <button onclick="upgradeRig(100000, 10, 25000, 'proRig')" data-key="buy">Buy</button>
        </div>
        <div class="shop-item" id="solar">
          <p data-key="solar_panel">Solar Panel</p>
          <p>+5 kW Solar, $10000</p>
          <button onclick="buySolar(5, 10000)" data-key="buy">Buy</button>
        </div>
        <div class="shop-item">
          <p data-key="gpu_upgrade">GPU Upgrade (Level 2)</p>
          <p>+1000 H/s, $2000</p>
          <button onclick="upgradeGPU(2, 2000)" data-key="buy">Buy</button>
        </div>
      </div>
    </div>

    <div id="missions" class="tab-content">
      <h2 data-key="missions_title">Missions</h2>
      <div id="missions-list"></div>
    </div>

    <div id="notification" class="notification"></div>
  </div>

  <script>
    let chart;
    let translations = {};
    let currentLang = 'en';

    function loadTranslations(lang) {
      fetch(`/translations/${lang}`)
        .then(response => response.json())
        .then(data => {
          translations = data;
          applyTranslations();
        });
    }

    function applyTranslations() {
      document.querySelectorAll('[data-key]').forEach(element => {
        const key = element.getAttribute('data-key');
        if (translations[key]) {
          if (element.tagName === 'BUTTON') {
            element.textContent = translations[key];
          } else {
            const span = element.querySelector('span');
            element.innerHTML = translations[key] + (span ? ` <span id="${span.id}">${span.textContent}</span>` : '');
          }
        }
      });
      document.title = translations['title'] || 'Bitcoin Mining Simulator';
      updateMissions();
    }

    function changeLanguage(lang) {
      currentLang = lang;
      loadTranslations(lang);
    }

    function showTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      document.querySelector(`button[onclick="showTab('${tabId}')"]`).classList.add('active');
      if (tabId === 'missions') updateMissions();
    }

    function showNotification(message) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.classList.add('show');
      setTimeout(() => notification.classList.remove('show'), 3000);
    }

    function updateStats() {
      fetch('/stats')
        .then(response => response.json())
        .then(data => {
          document.getElementById('level').textContent = data.level;
          document.getElementById('exp').textContent = data.exp;
          document.getElementById('expNeeded').textContent = data.level * 100;
          document.getElementById('hashRate').textContent = data.hashRate;
          document.getElementById('powerConsumption').textContent = data.powerConsumption;
          document.getElementById('totalPowerUsed').textContent = data.totalPowerUsed;
          document.getElementById('bitcoinMined').textContent = data.bitcoinMined;
          document.getElementById('blocksMined').textContent = data.blocksMined;
          document.getElementById('blockReward').textContent = data.blockReward;
          document.getElementById('wallet').textContent = data.wallet;
          document.getElementById('btcPrice').textContent = data.btcPrice;
          document.getElementById('difficulty').textContent = data.difficulty;
          document.getElementById('energyType').textContent = data.energyType;
          document.getElementById('solarPower').textContent = data.solarPower;
          document.getElementById('temp').textContent = data.temp;
          document.getElementById('gpuLevel').textContent = data.gpuLevel;

          document.getElementById('tradeBtcPrice').textContent = data.btcPrice;
          document.getElementById('tradeBitcoinMined').textContent = data.bitcoinMined;
          document.getElementById('tradeWallet').textContent = data.wallet;

          updateMiningLog(data.miningLog);
          updateChart(data.history);
          updateShopButtons(data.purchases);
        });
    }

    function updateMiningLog(log) {
      const logDiv = document.getElementById('miningLog');
      logDiv.innerHTML = log.map(entry => `<p>${entry}</p>`).join('');
    }

    function updateShopButtons(purchases) {
      if (purchases.basicRig) document.querySelector('#basicRig button').textContent = translations['purchased'] || 'Purchased';
      if (purchases.advancedRig) document.querySelector('#advancedRig button').textContent = translations['purchased'] || 'Purchased';
      if (purchases.proRig) document.querySelector('#proRig button').textContent = translations['purchased'] || 'Purchased';
      if (purchases.solar) document.querySelector('#solar button').textContent = translations['purchased'] || 'Purchased';
    }

    function startMining() {
      fetch('/start', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'overheat') showNotification(translations['overheat']);
          updateStats();
        });
    }

    function stopMining() {
      fetch('/stop', { method: 'POST' }).then(updateStats);
    }

    function upgradeRig(hashRate, power, cost, type) {
      fetch('/upgrade', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ hashRate, power, cost, type })
      }).then(response => response.json())
        .then(data => {
          if (data.status === 'insufficient_funds') showNotification(translations['insufficient_funds']);
          else if (data.status === 'already_purchased') showNotification(translations['already_purchased']);
          else showNotification(translations['purchase_success']);
          updateStats();
        });
    }

    function upgradeGPU(level, cost) {
      fetch('/upgrade-gpu', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ level, cost })
      }).then(response => response.json())
        .then(data => {
          if (data.status === 'insufficient_funds') showNotification(translations['insufficient_funds']);
          else showNotification(translations['purchase_success']);
          updateStats();
        });
    }

    function buySolar(power, cost) {
      fetch('/buy-solar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ power, cost })
      }).then(response => response.json())
        .then(data => {
          if (data.status === 'insufficient_funds') showNotification(translations['insufficient_funds']);
          else if (data.status === 'already_purchased') showNotification(translations['already_purchased']);
          else showNotification(translations['purchase_success']);
          updateStats();
        });
    }

    function tradeBTC(action) {
      const amount = parseFloat(document.getElementById('tradeAmount').value);
      if (!amount || amount <= 0) return showNotification(translations['invalid_amount']);
      fetch('/trade', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ amount, action })
      }).then(response => response.json())
        .then(data => {
          if (data.status === 'insufficient_funds') showNotification(translations['insufficient_funds']);
          if (data.status === 'insufficient_btc') showNotification(translations['insufficient_btc']);
          if (data.status === 'trade_success') showNotification(translations['trade_success']);
          updateStats();
        });
    }

    function saveGame() {
      fetch('/save', { method: 'POST' })
        .then(response => response.json())
        .then(data => showNotification(data.status === 'game_saved' ? translations['game_saved'] : translations['save_failed']));
    }

    function loadGame() {
      fetch('/load', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          showNotification(data.status === 'game_loaded' ? translations['game_loaded'] : translations['no_save_found']);
          updateStats();
        });
    }

    function updateChart(history) {
      const ctx = document.getElementById('miningChart').getContext('2d');
      if (!chart) {
        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [
              { label: translations['bitcoin_mined'] || 'BTC Mined', data: [], borderColor: '#f7931a', fill: false },
              { label: translations['btc_price'] || 'BTC Price ($)', data: [], borderColor: '#3498db', fill: false }
            ]
          },
          options: { scales: { y: { beginAtZero: false } } }
        });
      }
      chart.data.labels = history.map(h => h.time);
      chart.data.datasets[0].data = history.map(h => h.btcMined);
      chart.data.datasets[1].data = history.map(h => h.btcPrice);
      chart.update();
    }

    function updateMissions() {
      fetch('/stats')
        .then(response => response.json())
        .then(data => {
          const missionsList = document.getElementById('missions-list');
          missionsList.innerHTML = '';
          data.missions.forEach(mission => {
            const div = document.createElement('div');
            div.className = 'mission-item';
            div.innerHTML = `
              <p>${translations['mission']}: ${translations[mission.desc] || mission.desc}</p>
              <p>${translations['progress']}: ${mission.progress}/${mission.target}</p>
              <p>${translations['reward']}: $${mission.reward}</p>
              <p>${translations['status']}: ${mission.completed ? translations['completed'] : translations['in_progress']}</p>
            `;
            missionsList.appendChild(div);
          });
        });
    }

    loadTranslations('en');
    setInterval(updateStats, 1000);
    updateStats();
  </script>
</body>
</html>